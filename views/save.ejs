exports.forgotPasswordPage = async(req, res) => { res.render('forgot-password'); }; const nodemailer = require('nodemailer'); const randomstring = require('randomstring'); exports.forgotPassword = async(req, res, next) => { try { const { email } = req.body;
const user = await User.findOne({ email }); if (!user) { res.locals.message = 'Email không tồn tại!'; res.render('forgot-password'); } else { // Tạo mã xác thực ngẫu nhiên const token = randomstring.generate(6); user.resetPasswordToken = token; const
now = new Date(); const expires = new Date(now.getTime() + 3600 * 1000); // Thời gian hiện tại + 1 giờ user.resetPasswordExpires = expires; // Thời gian hết hạn của mã là 1 giờ await user.save(); // Gửi email chứa mã xác thực const transporter = nodemailer.createTransport({
host: 'smtp.elasticemail.com', port: 2525, secure: false, // true for 465, false for other ports auth: { user: 'hqmteams@gmail.com', // replace with your Elastic Email username pass: '5096F6B467FA7F4B9F284CE4E75F899C0DC8', // replace with your Elastic
Email password }, }); const mailOptions = { to: email, from: 'hqmteams@gmail.com', subject: 'HQM Glasses', text: `HQM teams nhận được yêu cầu thay đổi mật khẩu từ tài khoản của bạn.\n Mã xác nhận thay đổi mật khẩu: "${token}"\n Lưu ý :\n - Mã xác thực
chỉ có tác dụng trong 5 phút.\n - Nếu không phải bạn yêu cầu đổi mật khẩu xin hãy bỏ qua email này.\n` }; await transporter.sendMail(mailOptions); res.render('reset-password'); } } catch (err) { next(err); } };